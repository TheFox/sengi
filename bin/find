#!/usr/bin/env ruby
# coding: UTF-8

HTTP_USER_AGENT = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.108 Safari/537.36'

require 'optparse'
#require 'fileutils'
#require 'msgpack'
require 'uri'
require 'net/http'
require 'hiredis'
require 'redis'
require 'nokogiri'
require 'pp'
require 'sengi'


@options = {
}
opts = OptionParser.new do |o|
	o.banner = 'Usage: find [options] <url...>'
	o.separator('')
	
	o.on_tail('-h', '--help', 'Show this message.') do
		puts o
		puts
		exit 3
	end
end
ARGV << '-h' if ARGV.count == 0
urls = opts.parse(ARGV)

conn = Hiredis::Connection.new
conn.connect('127.0.0.1', 6379)
conn.write(['SET', 'hello', 'world'])
pp conn.read
conn.write(['GET', 'hello'])
pp conn.read

urls.each do |url|
	uri = URI(url)
	puts "get '#{url}'"
	
	http = Net::HTTP.new(uri.host, uri.port)
	if uri.scheme.to_s == 'https'
		http.use_ssl = true
		http.verify_mode = OpenSSL::SSL::VERIFY_NONE
	end
	
	request = Net::HTTP::Get.new(uri.request_uri)
	request['User-Agent'] = HTTP_USER_AGENT
	response = http.request(request)
	
	if response.code.to_i == 200
		if response['Content-Type'][0..8] == 'text/html'
			puts 'ok'
		else
			puts "wrong Content-Type: #{response['Content-Type']}"
		end
	else
		puts "wrong http status code: #{response.code}"
	end
	
	html_doc = Nokogiri::HTML(response.body)
end
