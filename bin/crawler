#!/usr/bin/env ruby
# coding: UTF-8

require 'optparse'
require 'resque'
require 'resque-scheduler'
require 'sengi'


@options = {
	:queue => false,
}
opts = OptionParser.new do |o|
	o.banner = 'Usage: crawler [options] <url...>'
	o.separator('')
	
	o.on_tail('-q', '--queue', 'Add URL to queue.') do
		@options[:queue] = true
	end
	
	o.on_tail('-h', '--help', 'Show this message.') do
		puts o
		puts
		exit 3
	end
end
ARGV << '-h' if ARGV.count == 0
urls = opts.parse(ARGV)

Resque.redis = '127.0.0.1:7000'
urls.each_with_index do |url, index|
	if @options[:queue]
		queued_time = (TheFox::Sengi::URL_DELAY + (TheFox::Sengi::URL_SEPARATE_DELAY * index)).seconds.from_now
		puts "queued for #{queued_time}"
		
		Resque.enqueue_at(queued_time, TheFox::Sengi::Crawler, url)
	else
		TheFox::Sengi::Crawler.perform(url)
	end
end
